<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PAUSE OSTIE â€” Gestionnaire</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:      #0f0f18;
    --surf:    #1a1a28;
    --surf2:   #22223a;
    --border:  #3a3a58;
    --accent:  #ff5533;
    --accent2: #ff8855;
    --green:   #2effe0;
    --blue:    #7dd6ff;
    --warn:    #ffd040;
    --text:    #ffffff;
    --dim:     #b0b0d0;
    --dimmer:  #70709a;
    --font:    'Poppins', sans-serif;
    --mono:    'Bebas Neue', sans-serif;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }
  body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: linear-gradient(rgba(255,85,51,.03) 1px,transparent 1px),
                      linear-gradient(90deg,rgba(255,85,51,.03) 1px,transparent 1px);
    background-size: 44px 44px;
  }

  /* â•â• LOGIN â•â• */
  #page-login {
    position: fixed; inset: 0; z-index: 200;
    display: flex; align-items: center; justify-content: center;
    background: var(--bg);
  }
  .login-box {
    width: 400px; background: var(--surf); border: 1px solid var(--border);
    padding: 52px 44px; position: relative; animation: fadeUp .5s ease;
  }
  .login-box::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
  }
  .login-logo { font-family: var(--mono); font-size: 52px; letter-spacing: 5px; color: var(--accent); }
  .login-sub  { font-size: 11px; font-weight: 600; color: var(--dim); letter-spacing: 3px;
                text-transform: uppercase; margin-bottom: 40px; }
  .fld { margin-bottom: 18px; }
  .fld label { display: block; font-size: 10px; font-weight: 700; letter-spacing: 2px;
               color: var(--text); text-transform: uppercase; margin-bottom: 7px; }
  .fld input { width: 100%; background: var(--bg); border: 1px solid var(--border);
               color: var(--text); font-family: var(--font); font-size: 15px; font-weight: 500;
               padding: 13px 16px; outline: none; transition: border-color .2s; }
  .fld input:focus { border-color: var(--accent); }
  .btn-login { width: 100%; background: var(--accent); color: #fff; border: none;
               font-family: var(--mono); font-size: 24px; letter-spacing: 4px;
               padding: 15px; cursor: pointer; margin-top: 8px; transition: all .2s; }
  .btn-login:hover { background: var(--accent2); }
  .login-err { font-size: 13px; font-weight: 600; color: var(--accent); margin-top: 12px;
               text-align: center; min-height: 18px; }

  /* â•â• APP â•â• */
  #app { display: none; position: relative; z-index: 1; min-height: 100vh; }

  /* Header */
  .hdr {
    background: var(--surf); border-bottom: 1px solid var(--border);
    padding: 0 28px; height: 62px; display: flex; align-items: center;
    justify-content: space-between; position: sticky; top: 0; z-index: 50;
  }
  .hdr-logo { font-family: var(--mono); font-size: 32px; letter-spacing: 5px; color: var(--accent); }
  .hdr-logo small { font-family: var(--font); font-size: 11px; font-weight: 600;
                    color: var(--dim); letter-spacing: 2px; display: block; margin-top: -4px; }
  .hdr-right { display: flex; align-items: center; gap: 12px; }
  .badge { font-size: 13px; font-weight: 700; color: var(--text);
           padding: 7px 16px; border: 1px solid var(--border); }
  .badge strong { color: var(--accent); font-size: 20px; }
  .sync-dot { font-size: 11px; font-weight: 700; letter-spacing: 1px;
              padding: 7px 12px; border: 1px solid var(--dimmer); color: var(--dimmer);
              text-transform: uppercase; transition: all .3s; }
  .sync-dot.ok  { color: var(--green); border-color: var(--green); }
  .sync-dot.err { color: var(--accent); border-color: var(--accent); }
  .sync-dot.syn { color: var(--warn); border-color: var(--warn); }
  .btn-sm { background: none; border: 1px solid var(--border); color: var(--dim);
            font-family: var(--font); font-size: 12px; font-weight: 700;
            letter-spacing: 1px; padding: 7px 14px; cursor: pointer;
            transition: all .2s; text-transform: uppercase; }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }

  /* Tabs */
  .tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surf); padding: 0 28px; }
  .tab  { font-size: 12px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
          padding: 15px 22px; cursor: pointer; border-bottom: 3px solid transparent;
          color: var(--dim); transition: all .2s; user-select: none; }
  .tab.active { color: var(--text); border-bottom-color: var(--accent); }
  .tab:hover:not(.active) { color: var(--text); }

  /* Content */
  .content { padding: 32px 28px; max-width: 960px; margin: 0 auto; }
  .pane { display: none; }
  .pane.active { display: block; animation: fadeUp .3s ease; }
  .pg-title { font-family: var(--mono); font-size: 36px; letter-spacing: 4px; margin-bottom: 4px; }
  .pg-sub    { font-size: 12px; font-weight: 600; color: var(--dim); letter-spacing: 2px;
               text-transform: uppercase; margin-bottom: 28px; }

  /* Capacity dots */
  .cap-row { display: flex; gap: 8px; align-items: center; margin-bottom: 24px; }
  .cap-dot { width: 38px; height: 38px; border: 2px solid var(--border);
             display: flex; align-items: center; justify-content: center;
             font-size: 15px; font-weight: 800; color: var(--dimmer); transition: all .3s; }
  .cap-dot.on { border-color: var(--accent); background: rgba(255,85,51,.15); color: var(--accent); }
  .cap-lbl { font-size: 13px; font-weight: 700; color: var(--text); margin-left: 10px;
             text-transform: uppercase; letter-spacing: 1px; }

  /* Send form */
  .send-card { background: var(--surf); border: 1px solid var(--border);
               padding: 32px; position: relative; }
  .send-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
                       background: linear-gradient(90deg, var(--accent), transparent); }
  .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .fblock label { display: block; font-size: 11px; font-weight: 700; letter-spacing: 2px;
                  color: var(--text); text-transform: uppercase; margin-bottom: 7px; }
  .fblock input { width: 100%; background: var(--bg); border: 1px solid var(--border);
                  color: var(--text); font-family: var(--font); font-size: 15px; font-weight: 500;
                  padding: 12px 16px; outline: none; transition: border-color .2s; }
  .fblock input:focus { border-color: var(--accent); }
  .preview { background: var(--bg); border: 1px solid var(--border); border-left: 3px solid var(--green);
             padding: 14px 18px; margin-bottom: 20px; display: none; animation: fadeUp .2s ease; }
  .preview.show { display: block; }
  .prev-name { font-size: 18px; font-weight: 800; color: #fff; margin-bottom: 3px; }
  .prev-info { font-size: 12px; font-weight: 500; color: var(--dim); }
  .btn-send { width: 100%; background: var(--accent); color: #fff; border: none;
              font-family: var(--mono); font-size: 28px; letter-spacing: 5px;
              padding: 18px; cursor: pointer; transition: all .2s; }
  .btn-send:hover:not(:disabled) { background: var(--accent2); }
  .btn-send:disabled { background: var(--surf2); cursor: not-allowed; color: var(--dimmer); }
  .send-warn { font-size: 12px; font-weight: 600; color: var(--warn); text-align: center;
               margin-top: 10px; min-height: 18px; }

  /* Agent cards (En cours) */
  .agent-list { display: flex; flex-direction: column; gap: 12px; }
  .agent-card { background: var(--surf); border: 1px solid var(--border);
                padding: 20px 24px; display: flex; align-items: flex-start;
                justify-content: space-between; position: relative; animation: slideIn .3s ease; }
  .agent-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0;
                        width: 4px; background: var(--green); }
  .agent-card.warn::before { background: var(--warn); }
  .agent-card.over::before { background: var(--accent); animation: pulse 1s infinite; }
  .ag-fields { display: flex; flex-direction: column; gap: 6px; flex: 1; }
  .ag-row { display: flex; align-items: baseline; gap: 8px; }
  .ag-lbl { font-size: 10px; font-weight: 800; letter-spacing: 1.5px; color: var(--dim);
            text-transform: uppercase; min-width: 120px; white-space: nowrap; }
  .ag-lbl::after { content: ' :'; }
  .ag-val { font-size: 14px; font-weight: 600; color: #fff; }
  .ag-val.big  { font-size: 17px; font-weight: 800; }
  .ag-val.time { font-size: 13px; font-weight: 700; color: var(--blue); }
  .ag-right { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; flex-shrink: 0; margin-left: 24px; }
  .chrono-lbl  { font-size: 10px; font-weight: 800; color: var(--dim); letter-spacing: 2px;
                 text-transform: uppercase; text-align: right; }
  .chrono-val  { font-family: var(--mono); font-size: 40px; letter-spacing: 2px;
                 color: var(--green); line-height: 1; transition: color .3s; }
  .chrono-val.warn { color: var(--warn); }
  .chrono-val.over { color: var(--accent); animation: pulse 1s infinite; }
  .btn-retour { background: var(--green); border: none; color: #000;
                font-family: var(--font); font-size: 13px; font-weight: 800;
                letter-spacing: 1px; padding: 10px 20px; cursor: pointer;
                transition: all .2s; text-transform: uppercase; white-space: nowrap; }
  .btn-retour:hover { background: #00ffcc; transform: scale(1.03); }

  /* Empty state */
  .empty { text-align: center; padding: 80px 0; color: var(--dimmer);
           font-size: 13px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
  .empty .ico { font-size: 64px; margin-bottom: 16px; }

  /* History cards */
  .hist-card { background: var(--surf); border: 1px solid var(--border);
               border-left: 4px solid var(--blue); padding: 18px 22px;
               display: flex; align-items: flex-start; justify-content: space-between;
               margin-bottom: 10px; animation: fadeUp .3s ease; }
  .hist-fields { display: flex; flex-direction: column; gap: 5px; flex: 1; }
  .hist-times { font-size: 12px; font-weight: 600; color: var(--dim); margin-top: 6px; line-height: 1.8; }
  .hist-right { text-align: right; flex-shrink: 0; margin-left: 20px; }
  .hist-dur-lbl { font-size: 10px; font-weight: 800; color: var(--dim);
                  letter-spacing: 1px; text-transform: uppercase; }
  .hist-dur { font-family: var(--mono); font-size: 32px; color: var(--blue); letter-spacing: 2px; }

  /* Admin */
  .admin-card { background: var(--surf); border: 1px solid var(--border);
                padding: 28px; margin-bottom: 20px; position: relative; }
  .admin-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
                        background: linear-gradient(90deg, var(--warn), transparent); }
  .admin-card h3 { font-family: var(--mono); font-size: 22px; letter-spacing: 3px; margin-bottom: 16px; }
  .user-row { display: flex; align-items: center; justify-content: space-between;
              background: var(--bg); padding: 10px 14px; border: 1px solid var(--border);
              font-size: 13px; font-weight: 600; color: var(--dim); margin-bottom: 7px; }
  .user-row strong { color: #fff; }
  .user-role { font-size: 10px; font-weight: 700; color: var(--dimmer);
               letter-spacing: 1px; text-transform: uppercase; }
  .btn-del { background: none; border: none; color: var(--dimmer);
             font-size: 18px; cursor: pointer; transition: color .2s; padding: 2px 6px; }
  .btn-del:hover { color: var(--accent); }
  .admin-form { display: flex; flex-direction: column; gap: 10px; margin-top: 14px; }
  .admin-form input { background: var(--bg); border: 1px solid var(--border); color: #fff;
                      font-family: var(--font); font-size: 14px; font-weight: 500;
                      padding: 11px 14px; outline: none; transition: border-color .2s; }
  .admin-form input:focus { border-color: var(--warn); }
  .btn-add { background: none; border: 1px solid var(--warn); color: var(--warn);
             font-family: var(--font); font-size: 13px; font-weight: 800;
             letter-spacing: 1px; padding: 11px; cursor: pointer;
             transition: all .2s; text-transform: uppercase; }
  .btn-add:hover { background: var(--warn); color: var(--bg); }
  .url-box { background: var(--bg); border: 1px solid var(--border);
             padding: 12px 16px; font-size: 12px; font-weight: 600;
             color: var(--green); word-break: break-all; }

  /* Notification */
  .notif { position: fixed; bottom: 24px; right: 24px; background: var(--surf);
           border: 1px solid var(--border); border-left: 4px solid var(--green);
           padding: 14px 18px; font-size: 13px; font-weight: 700; color: #fff;
           z-index: 300; animation: fadeUp .3s ease; max-width: 320px; }
  .notif.err  { border-left-color: var(--accent); }
  .notif.warn { border-left-color: var(--warn); }

  /* Modal */
  .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.88);
              z-index: 400; display: none; align-items: center; justify-content: center; }
  .modal-bg.open { display: flex; }
  .modal { background: #22223a; border: 2px solid var(--border);
           padding: 40px; width: 480px; animation: fadeUp .3s ease; }
  .modal-ttl { font-family: var(--mono); font-size: 28px; letter-spacing: 3px; margin-bottom: 20px; }
  .modal-body { font-size: 15px; font-weight: 500; color: #fff; line-height: 1.9; margin-bottom: 28px; }
  .modal-btns { display: flex; gap: 12px; }
  .btn-ok  { flex: 1; background: var(--green); border: none; color: #000;
             font-family: var(--font); font-size: 15px; font-weight: 800;
             letter-spacing: 1px; padding: 13px; cursor: pointer; text-transform: uppercase; }
  .btn-ok:hover { background: #00ffcc; }
  .btn-no  { flex: 1; background: none; border: 1px solid var(--border); color: var(--dim);
             font-family: var(--font); font-size: 15px; font-weight: 700;
             letter-spacing: 1px; padding: 13px; cursor: pointer; text-transform: uppercase; }
  .btn-no:hover { border-color: #fff; color: #fff; }

  .hidden { display: none !important; }

  @keyframes fadeUp   { from { opacity: 0; transform: translateY(14px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideIn  { from { opacity: 0; transform: translateX(-14px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes pulse    { 0%,100% { opacity: 1; } 50% { opacity: .4; } }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); }
  @media (max-width:640px) {
    .grid2 { grid-template-columns: 1fr; }
    .content { padding: 20px 14px; }
    .ag-right { margin-left: 10px; }
    .chrono-val { font-size: 28px; }
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="page-login">
  <div class="login-box">
    <div class="login-logo">PAUSE</div>
    <div class="login-sub">Gestionnaire OSTIE â€” AccÃ¨s restreint</div>
    <div class="fld">
      <label>Identifiant</label>
      <input type="text" id="li-user" placeholder="admin" autocomplete="off">
    </div>
    <div class="fld">
      <label>Mot de passe</label>
      <input type="password" id="li-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn-login" onclick="doLogin()">CONNEXION</button>
    <div class="login-err" id="li-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header class="hdr">
    <div class="hdr-logo">PAUSE OSTIE <small>Sync en direct Â· Toutes les 5 s</small></div>
    <div class="hdr-right">
      <div class="sync-dot" id="sync-dot">â¬¤ â€”</div>
      <div class="badge">EN PAUSE : <strong id="hdr-n">0</strong> / 5</div>
      <button class="btn-sm hidden" id="btn-admin-tab" onclick="goTab('admin')">âš™ ADMIN</button>
      <button class="btn-sm" onclick="doLogout()">â» DÃ‰CO</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="send"    onclick="goTab('send')">â†‘ ENVOYER EN PAUSE</div>
    <div class="tab"        data-tab="encours" onclick="goTab('encours')">â± EN COURS</div>
    <div class="tab"        data-tab="hist"    onclick="goTab('hist')">ğŸ“‹ HISTORIQUE GLOBAL</div>
    <div class="tab hidden" data-tab="admin"   onclick="goTab('admin')">âš™ ADMIN</div>
  </div>

  <div class="content">

    <!-- SEND -->
    <div class="pane active" id="pane-send">
      <div class="pg-title">ENVOYER EN PAUSE</div>
      <div class="pg-sub">Matricule â†’ nom automatique â€” max 5 simultanÃ©s</div>
      <div class="cap-row" id="cap-row"></div>
      <div class="send-card">
        <div class="grid2">
          <div class="fblock">
            <label>Matricule</label>
            <input type="text" id="in-mat" placeholder="ex : CN00663" maxlength="20"
              oninput="onMat(this.value)" onkeydown="if(event.key==='Enter')sendPause()">
          </div>
          <div class="fblock">
            <label>Note (optionnel)</label>
            <input type="text" id="in-note" placeholder="ex : Visite mÃ©dicale" maxlength="50">
          </div>
        </div>
        <div class="preview" id="preview">
          <div class="prev-name" id="prev-name">â€”</div>
          <div class="prev-info" id="prev-info">â€”</div>
        </div>
        <button class="btn-send" id="btn-send" onclick="sendPause()" disabled>
          ENVOYER EN PAUSE
        </button>
        <div class="send-warn" id="send-warn"></div>
      </div>
    </div>

    <!-- EN COURS -->
    <div class="pane" id="pane-encours">
      <div class="pg-title">EN COURS</div>
      <div class="pg-sub">Agents actuellement en pause â€” chrono en temps rÃ©el</div>
      <div id="list-encours">
        <div class="empty"><div class="ico">â˜•</div>Aucun agent en pause</div>
      </div>
    </div>

    <!-- HISTORIQUE -->
    <div class="pane" id="pane-hist">
      <div class="pg-title">HISTORIQUE GLOBAL</div>
      <div class="pg-sub">Toutes les pauses terminÃ©es â€” visible par tous</div>
      <div id="list-hist">
        <div class="empty"><div class="ico">ğŸ“‹</div>Aucune pause enregistrÃ©e</div>
      </div>
    </div>

    <!-- ADMIN -->
    <div class="pane hidden" id="pane-admin">
      <div class="pg-title">ADMINISTRATION</div>
      <div class="pg-sub">Gestion des accÃ¨s et configuration</div>

      <div class="admin-card">
        <h3>CONNEXION GOOGLE SHEETS</h3>
        <p style="font-size:12px;font-weight:500;color:var(--dim);margin-bottom:12px;">URL Apps Script active pour tous les utilisateurs :</p>
        <div class="url-box" id="url-box">â€”</div>
        <div style="margin-top:10px;font-size:12px;font-weight:700;color:var(--green);" id="url-status">âœ“ Connexion configurÃ©e automatiquement</div>
      </div>

      <div class="admin-card">
        <h3>UTILISATEURS</h3>
        <div id="user-list"></div>
        <div class="admin-form">
          <input type="text"     id="nu-user" placeholder="Nom d'utilisateur" autocomplete="off">
          <input type="password" id="nu-pass" placeholder="Mot de passe" autocomplete="off">
          <button class="btn-add" onclick="addUser()">+ AJOUTER UN UTILISATEUR</button>
        </div>
      </div>

      <div class="admin-card">
        <h3>STATISTIQUES SESSION</h3>
        <div style="font-size:13px;font-weight:600;color:var(--dim);line-height:2.8;">
          <div>ConnectÃ© : <span id="s-user" style="color:#fff;font-weight:800;">â€”</span></div>
          <div>En pause maintenant : <span id="s-count" style="color:var(--accent);font-weight:800;">0</span> / 5</div>
          <div>Pauses terminÃ©es (total) : <span id="s-hist"  style="color:var(--warn);font-weight:800;">0</span></div>
          <div>Agents dans la base : <span id="s-agents" style="color:var(--green);font-weight:800;">0</span></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modal">
  <div class="modal">
    <div class="modal-ttl" id="modal-ttl">CONFIRMATION</div>
    <div class="modal-body" id="modal-body">â€”</div>
    <div class="modal-btns">
      <button class="btn-ok" id="modal-ok">CONFIRMER</button>
      <button class="btn-no" onclick="closeModal()">ANNULER</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” URL PARTAGÃ‰E, JAMAIS CHANGÃ‰E
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzFuCSOAi8vdQttgnYZt7gL55eDi04YxBV-fKLvL6iF9omVz_fh2rTD-ej3zNeIEQc_/exec';
const MAX        = 5;
const POLL_MS    = 5000;
const SESSION_KEY = 'pause_session'; // clÃ© localStorage pour maintenir la session

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let me         = null;   // user connectÃ©
let agentsDB   = {};     // matricule â†’ {nom, equipe}
let pauseList  = [];     // pauses actives (depuis Sheets)
let histList   = [];     // pauses terminÃ©es (depuis Sheets)
let pollTmr    = null;
let tickTmr    = null;
let removing   = new Set(); // IDs en cours de suppression (Ã©vite les doublons)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STORAGE USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Cache users chargÃ©s depuis Sheets â”€â”€
let usersCache = [];

async function loadUsers() {
  try {
    const res  = await fetch(SHEETS_URL + '?action=getUsers&t=' + Date.now());
    const data = await res.json();
    if (Array.isArray(data) && data.length > 0) {
      usersCache = data; // [{u, p, role}]
    } else {
      // Fallback si onglet User vide ou absent
      usersCache = [{ u: 'admin', p: 'admin', role: 'admin' }];
    }
  } catch(e) {
    usersCache = [{ u: 'admin', p: 'admin', role: 'admin' }];
  }
}

function getUsers() { return usersCache; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SESSION PERSISTANTE (survit Ã  l'actualisation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSession() {
  try {
    const s = sessionStorage.getItem(SESSION_KEY);
    if (s) { me = JSON.parse(s); return true; }
  } catch(e) {}
  return false;
}
function saveSession(user) {
  sessionStorage.setItem(SESSION_KEY, JSON.stringify(user));
}
function clearSession() {
  sessionStorage.removeItem(SESSION_KEY);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN / LOGOUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('li-pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });
document.getElementById('li-user').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('li-pass').focus(); });

async function doLogin() {
  const u   = document.getElementById('li-user').value.trim();
  const p   = document.getElementById('li-pass').value;
  const btn = document.querySelector('.btn-login');
  const err = document.getElementById('li-err');

  err.textContent  = '';
  btn.textContent  = 'CONNEXION...';
  btn.disabled     = true;

  await loadUsers();

  btn.textContent  = 'CONNEXION';
  btn.disabled     = false;

  const found = usersCache.find(x => x.u === u && x.p === p);
  if (!found) {
    err.textContent = 'âœ• Identifiants incorrects';
    document.getElementById('li-pass').value = '';
    return;
  }
  me = found;
  saveSession(me);
  bootApp();
}

function doLogout() {
  me = null;
  clearSession();
  clearInterval(pollTmr);
  clearInterval(tickTmr);
  pauseList = []; histList = [];
  document.getElementById('app').style.display = 'none';
  document.getElementById('page-login').style.display = 'flex';
  document.getElementById('li-user').value = '';
  document.getElementById('li-pass').value = '';
  document.getElementById('li-err').textContent = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT (login OU retour aprÃ¨s F5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bootApp() {
  document.getElementById('page-login').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('s-user').textContent = me.u;
  document.getElementById('url-box').textContent = SHEETS_URL;

  if (me.role === 'admin') {
    document.getElementById('btn-admin-tab').classList.remove('hidden');
    document.querySelectorAll('[data-tab="admin"]').forEach(el => el.classList.remove('hidden'));
    document.getElementById('pane-admin').classList.remove('hidden');
  }

  renderCap();
  fetchAgents();
  fetchPauses();
  fetchHistory();
  clearInterval(pollTmr);
  pollTmr = setInterval(() => { fetchPauses(); fetchHistory(); }, POLL_MS);
  clearInterval(tickTmr);
  tickTmr = setInterval(tick, 1000);
  renderUserList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-LOGIN si session active (F5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', async () => {
  await loadUsers(); // charger les users Sheets avant tout
  if (loadSession()) {
    bootApp();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
  document.querySelectorAll('.pane').forEach(p => p.classList.toggle('active', p.id === 'pane-' + name));
  if (name === 'admin') { renderUserList(); updateStats(); }
  if (name === 'hist')  renderHist();
  if (name === 'encours') renderEncours();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC DOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sync(state) {
  const d = document.getElementById('sync-dot');
  const map = { ok: ['â¬¤ SYNC', 'ok'], syn: ['âŸ³ SYNC', 'syn'], err: ['â¬¤ HORS LIGNE', 'err'] };
  const [txt, cls] = map[state] || map.err;
  d.textContent = txt;
  d.className = 'sync-dot ' + cls;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS â€” AGENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchAgents() {
  try {
    const r    = await fetch(SHEETS_URL + '?action=getAgents&t=' + Date.now());
    const data = await r.json();
    if (Array.isArray(data) && data.length) {
      agentsDB = {};
      data.forEach(row => {
        if (row.matricule) agentsDB[row.matricule.trim()] = { nom: row.nom || 'â€”', equipe: row.equipe || 'â€”' };
      });
      document.getElementById('s-agents').textContent = Object.keys(agentsDB).length;
    }
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS â€” PAUSES EN COURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPauses() {
  sync('syn');
  try {
    const r    = await fetch(SHEETS_URL + '?action=getPauses&t=' + Date.now());
    const data = await r.json();
    if (!Array.isArray(data)) throw new Error();

    // Merge : prÃ©serve startTime local pour chrono stable
    // DEBUG â€” afficher le format brut reÃ§u de Sheets (supprimer aprÃ¨s fix)
    if (data.length > 0) {
      const raw = data[0].startTime;
      console.log('[DEBUG startTime brut]', typeof raw, JSON.stringify(raw));
      toast('[DEBUG] startTime = ' + JSON.stringify(raw).substring(0,40), 'warn');
    }

    pauseList = data
      .filter(row => !removing.has(String(row.id)))
      .map(row => {
        const ex  = pauseList.find(p => String(p.id) === String(row.id));
        const ts  = ex ? ex.startTime : sheetsToTs(row.startTime);
        console.log('[DEBUG] id='+row.id+' startTime='+row.startTime+' â†’ ts='+ts);
        return {
          id:        String(row.id),
          matricule: row.matricule,
          nom:       row.nom,
          equipe:    row.equipe,
          note:      row.note || '',
          startTime: ts
        };
      });

    renderCap();
    renderEncours();
    updateStats();
    sync('ok');
  } catch(e) { sync('err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS â€” HISTORIQUE (TerminÃ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchHistory() {
  try {
    const r    = await fetch(SHEETS_URL + '?action=getHistory&t=' + Date.now());
    const data = await r.json();
    if (!Array.isArray(data)) return;

    histList = data.map(row => {
      const st = sheetsToTs(row.startTime);
      const et = sheetsToTs(row.endTime);
      return {
        id:        String(row.id),
        matricule: row.matricule,
        nom:       row.nom,
        equipe:    row.equipe,
        note:      row.note || '',
        startTime: st,
        endTime:   et,
        startStr:  row.startTime || '',
        endStr:    row.endTime   || '',
        duration:  (st && et) ? Math.floor((et - st) / 1000) : null
      };
    });

    renderHist();
    document.getElementById('s-hist').textContent = histList.length;
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PUSH / REMOVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pushPause(entry) {
  sync('syn');
  try {
    const p = new URLSearchParams({
      action: 'addPause',
      id:        String(entry.id),
      matricule: entry.matricule,
      nom:       entry.nom,
      equipe:    entry.equipe,
      note:      entry.note || '',
      startTime: String(entry.startTime)
    });
    await fetch(SHEETS_URL + '?' + p);
    sync('ok');
    return true;
  } catch(e) { sync('err'); return false; }
}

async function pushRemove(id, finStr) {
  sync('syn');
  try {
    const p = new URLSearchParams({ action: 'removePause', id: String(id), fin: finStr || '' });
    await fetch(SHEETS_URL + '?' + p);
    sync('ok');
    return true;
  } catch(e) { sync('err'); return false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MATRICULE INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onMat(val) {
  const mat  = val.trim();
  const prev = document.getElementById('preview');
  const btn  = document.getElementById('btn-send');
  const warn = document.getElementById('send-warn');

  if (!mat) { prev.classList.remove('show'); btn.disabled = true; warn.textContent = ''; return; }
  if (pauseList.find(p => p.matricule === mat)) {
    prev.classList.remove('show'); btn.disabled = true;
    warn.textContent = 'âš  Cet agent est dÃ©jÃ  en pause.'; return;
  }
  if (pauseList.length >= MAX) {
    prev.classList.remove('show'); btn.disabled = true;
    warn.textContent = 'â›” Maximum 5 agents atteint.'; return;
  }
  const ag = agentsDB[mat];
  if (ag) {
    document.getElementById('prev-name').textContent = ag.nom;
    document.getElementById('prev-info').textContent = 'Matricule : ' + mat + '  â€”  ' + ag.equipe;
    prev.classList.add('show');
    btn.disabled = false;
    warn.textContent = '';
  } else {
    prev.classList.remove('show'); btn.disabled = true;
    warn.textContent = 'âœ• Matricule introuvable dans la base.';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENVOYER EN PAUSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendPause() {
  const mat  = document.getElementById('in-mat').value.trim();
  const note = document.getElementById('in-note').value.trim();
  if (!mat || pauseList.length >= MAX) return;
  const ag = agentsDB[mat];
  if (!ag) return;

  const entry = { id: Date.now(), matricule: mat, nom: ag.nom, equipe: ag.equipe, note, startTime: Date.now() };

  // Optimistic
  pauseList.push(entry);
  document.getElementById('in-mat').value = '';
  document.getElementById('in-note').value = '';
  document.getElementById('preview').classList.remove('show');
  document.getElementById('btn-send').disabled = true;
  document.getElementById('send-warn').textContent = '';
  renderCap();
  renderEncours();
  updateStats();
  toast('âœ“ ' + ag.nom + ' envoyÃ©(e) en pause');

  await pushPause(entry);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RETOUR â€” confirmation puis suppression
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function retourAgent(id) {
  const sid = String(id);
  const p   = pauseList.find(x => String(x.id) === sid);
  if (!p) return;

  const now     = Date.now();
  const elapsed = Math.floor((now - p.startTime) / 1000);

  // PrÃ©parer la modale
  document.getElementById('modal-ttl').textContent = 'CONFIRMER LE RETOUR';
  document.getElementById('modal-body').innerHTML =
    `<span style="font-size:19px;font-weight:800;color:#fff;display:block;margin-bottom:6px;">${p.nom}</span>` +
    `<span style="color:var(--dim);font-size:13px;">Matricule : ${p.matricule} â€” ${p.equipe}</span><br><br>` +
    `<span style="font-size:22px;font-weight:800;color:var(--green);">â± ${fmt(elapsed)}</span><br>` +
    `<span style="color:var(--dim);font-size:12px;">DÃ©part : ${fmtDT(p.startTime)}</span><br><br>` +
    `<span style="color:var(--warn);font-weight:700;">Confirmer le retour de cet agent ?</span>`;

  document.getElementById('modal').classList.add('open');

  // Bouton OK â€” exÃ©cution async directe, pas de wrapper
  const btnOk = document.getElementById('modal-ok');
  // Retirer tout ancien listener pour Ã©viter les doublons
  const fresh = btnOk.cloneNode(true);
  btnOk.parentNode.replaceChild(fresh, btnOk);

  fresh.addEventListener('click', async function handler() {
    // Fermer la modale
    document.getElementById('modal').classList.remove('open');

    const nowConfirm = Date.now();
    const dur        = Math.floor((nowConfirm - p.startTime) / 1000);
    const finStr     = fmtSheets(nowConfirm);

    // Marquer comme en cours de suppression pour bloquer le polling
    removing.add(sid);

    // Retirer localement
    pauseList = pauseList.filter(x => String(x.id) !== sid);
    renderCap();
    renderEncours();
    updateStats();
    onMat(document.getElementById('in-mat').value);
    toast('â†© ' + p.nom + ' â€” retour confirmÃ© (' + fmt(dur) + ')', 'warn');

    // ArrÃªter le polling pendant le sync
    clearInterval(pollTmr);

    // Envoyer Ã  Sheets
    const ok = await pushRemove(sid, finStr);
    if (!ok) toast('âš  Erreur sync â€” vÃ©rifiez la connexion', 'err');

    // Retirer du set de suppression
    removing.delete(sid);

    // Recharger et relancer le polling
    await fetchPauses();
    await fetchHistory();
    pollTmr = setInterval(() => { fetchPauses(); fetchHistory(); }, POLL_MS);
  });
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€” CAPACITÃ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCap() {
  const bar = document.getElementById('cap-row');
  bar.innerHTML = '';
  for (let i = 1; i <= MAX; i++) {
    const d = document.createElement('div');
    d.className = 'cap-dot' + (i <= pauseList.length ? ' on' : '');
    d.textContent = i;
    bar.appendChild(d);
  }
  const lbl = document.createElement('div');
  lbl.className = 'cap-lbl';
  lbl.textContent = pauseList.length + ' / 5 en pause';
  bar.appendChild(lbl);
  document.getElementById('hdr-n').textContent = pauseList.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€” EN COURS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEncours() {
  const c = document.getElementById('list-encours');
  if (!pauseList.length) {
    c.innerHTML = '<div class="empty"><div class="ico">â˜•</div>Aucun agent en pause</div>';
    return;
  }
  c.innerHTML = '<div class="agent-list">' + pauseList.map(p => {
    const el  = Math.floor((Date.now() - p.startTime) / 1000);
    const cls = el >= 900 ? 'over' : el >= 720 ? 'warn' : '';
    const cc  = el >= 900 ? 'over' : el >= 720 ? 'warn' : '';
    return `<div class="agent-card ${cls}" id="card-${p.id}">
      <div class="ag-fields">
        <div class="ag-row"><span class="ag-lbl">Matricule</span><span class="ag-val">${p.matricule}</span></div>
        <div class="ag-row"><span class="ag-lbl">Nom et prÃ©nom</span><span class="ag-val big">${p.nom}</span></div>
        <div class="ag-row"><span class="ag-lbl">Fonction</span><span class="ag-val">${p.equipe}</span></div>
        ${p.note ? `<div class="ag-row"><span class="ag-lbl">Note</span><span class="ag-val">${p.note}</span></div>` : ''}
        <div class="ag-row"><span class="ag-lbl">DÃ©part en pause</span><span class="ag-val time">${fmtDT(p.startTime)}</span></div>
      </div>
      <div class="ag-right">
        <div>
          <div class="chrono-lbl">DurÃ©e</div>
          <div class="chrono-val ${cc}" id="chr-${p.id}">${fmt(el)}</div>
        </div>
        <button class="btn-retour" onclick="retourAgent('${p.id}')">âœ“ RETOUR</button>
      </div>
    </div>`;
  }).join('') + '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER â€” HISTORIQUE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHist() {
  const c = document.getElementById('list-hist');
  if (!histList.length) {
    c.innerHTML = '<div class="empty"><div class="ico">ğŸ“‹</div>Aucune pause enregistrÃ©e</div>';
    return;
  }
  c.innerHTML = histList.map(p => {
    const dur = p.duration != null ? fmt(p.duration) : 'â€”';
    return `<div class="hist-card">
      <div class="hist-fields">
        <div class="ag-row"><span class="ag-lbl">Matricule</span><span class="ag-val">${p.matricule}</span></div>
        <div class="ag-row"><span class="ag-lbl">Nom et prÃ©nom</span><span class="ag-val big">${p.nom}</span></div>
        <div class="ag-row"><span class="ag-lbl">Fonction</span><span class="ag-val">${p.equipe}</span></div>
        ${p.note ? `<div class="ag-row"><span class="ag-lbl">Note</span><span class="ag-val">${p.note}</span></div>` : ''}
        <div class="hist-times">
          â–¶ DÃ©part : <strong>${fmtDT(p.startTime)}</strong><br>
          â—¼ Retour : <strong>${fmtDT(p.endTime)}</strong>
        </div>
      </div>
      <div class="hist-right">
        <div class="hist-dur-lbl">DurÃ©e totale</div>
        <div class="hist-dur">${dur}</div>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICK â€” chrono en temps rÃ©el
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick() {
  pauseList.forEach(p => {
    const el  = Math.floor((Date.now() - p.startTime) / 1000);
    const cls = el >= 900 ? 'over' : el >= 720 ? 'warn' : '';
    const cv  = document.getElementById('chr-' + p.id);
    const cd  = document.getElementById('card-' + p.id);
    if (cv) { cv.textContent = fmt(el); cv.className = 'chrono-val ' + cls; }
    if (cd) cd.className = 'agent-card ' + cls;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADMIN â€” USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderUserList() {
  const users = getUsers();
  document.getElementById('user-list').innerHTML = users.map((u, i) => `
    <div class="user-row">
      <div><strong>${u.u}</strong><div class="user-role">${u.role}</div></div>
      ${u.u !== 'admin'
        ? `<button class="btn-del" onclick="delUser(${i})">âœ•</button>`
        : '<span style="font-size:10px;color:var(--dimmer)">PROTÃ‰GÃ‰</span>'}
    </div>`).join('');
}

function addUser() {
  const un = document.getElementById('nu-user').value.trim();
  const pw = document.getElementById('nu-pass').value;
  if (!un || !pw) { toast('Remplissez tous les champs', 'err'); return; }
  const users = getUsers();
  if (users.find(x => x.u === un)) { toast('Utilisateur dÃ©jÃ  existant', 'err'); return; }
  users.push({ u: un, p: pw, role: 'user' });
  saveUsers(users);
  document.getElementById('nu-user').value = '';
  document.getElementById('nu-pass').value = '';
  renderUserList();
  toast('âœ“ Utilisateur ' + un + ' ajoutÃ©');
}

function delUser(i) {
  const users = getUsers();
  if (!users[i] || users[i].u === 'admin') return;
  const name = users[i].u;
  users.splice(i, 1);
  saveUsers(users);
  renderUserList();
  toast('Utilisateur ' + name + ' supprimÃ©', 'warn');
}

function updateStats() {
  document.getElementById('s-count').textContent  = pauseList.length;
  document.getElementById('s-agents').textContent = Object.keys(agentsDB).length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATAGE DATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// "25/02/2026 15:26:25" â†’ timestamp ms
function sheetsToTs(str) {
  if (!str || str === '') return null;
  const s = String(str).trim();

  // Format 1 : "25/02/2026 15:26:25"  (dd/mm/yyyy hh:mm:ss)
  const m1 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
  if (m1) return new Date(+m1[3], +m1[2]-1, +m1[1], +m1[4], +m1[5], +m1[6]).getTime();

  // Format 2 : ISO "2026-02-25T15:26:25.000Z" (quand Apps Script renvoie un objet Date)
  const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
  if (m2) return new Date(s).getTime();

  // Format 3 : timestamp numÃ©rique en string
  if (/^\d{10,}$/.test(s)) return parseInt(s);

  return null;
}

// timestamp ms â†’ "25/02/2026 15:26:25" (pour Ã©crire dans Sheets)
function fmtSheets(ts) {
  const d = new Date(ts);
  const z = n => String(n).padStart(2,'0');
  return z(d.getDate())+'/'+z(d.getMonth()+1)+'/'+d.getFullYear()
    +' '+z(d.getHours())+':'+z(d.getMinutes())+':'+z(d.getSeconds());
}

// Affichage : "02-25 â° 15 h 33 min 38 s"
function fmtDT(ts) {
  if (!ts) return 'â€”';
  const d = new Date(typeof ts === 'number' ? ts : Number(ts));
  if (isNaN(d.getTime())) return String(ts);
  const z = n => String(n).padStart(2,'0');
  return z(d.getMonth()+1)+'-'+z(d.getDate())+' â° '
    + d.getHours()+' h '+z(d.getMinutes())+' min '+z(d.getSeconds())+' s';
}

// mm:ss
function fmt(s) {
  if (s == null || isNaN(s)) return 'â€”';
  return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type = 'ok') {
  const el = document.createElement('div');
  el.className = 'notif ' + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
</script>
</body>
</html>
